---
title: "Datacleaningcode_ID"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(tidyverse)
#here are functions
#for temperature

resultconvert_celsius<-function(dat, variable, unit, out_unit) {
  dat$ResultMeasureValue[which(dat$CharacteristicName == variable & dat$ResultMeasure.MeasureUnitCode == unit)] <- (dat$ResultMeasureValue[which(dat$CharacteristicName == variable & dat$ResultMeasure.MeasureUnitCode == unit)] -32)* 5/9
  
dat$ResultMeasure.MeasureUnitCode[which(dat$CharacteristicName == variable & dat$ResultMeasure.MeasureUnitCode == unit)] <- out_unit

return(dat)
  
}


detectconvert_celsius<-function(dat, variable, unit, out_unit) {
  dat$DetectionQuantitationLimitMeasure.MeasureValue[which(dat$CharacteristicName == variable & dat$DetectionQuantitationLimitMeasure.MeasureUnitCode == unit)] <- (dat$DetectionQuantitationLimitMeasure.MeasureValue[which(dat$CharacteristicName == variable & dat$DetectionQuantitationLimitMeasure.MeasureUnitCode == unit)] * -32)*5/9
  
dat$DetectionQuantitationLimitMeasure.MeasureUnitCode[which(dat$CharacteristicName == variable & dat$DetectionQuantitationLimitMeasure.MeasureUnitCode == unit)] <- out_unit

return(dat)
  
}

#for all other conversions

resultconvert<-function(dat, variable, unit, out_unit, conv_factor) {
  dat$ResultMeasureValue[which(dat$CharacteristicName == variable & dat$ResultMeasure.MeasureUnitCode == unit)] <- dat$ResultMeasureValue[which(dat$CharacteristicName == variable & dat$ResultMeasure.MeasureUnitCode == unit)] * conv_factor
  
dat$ResultMeasure.MeasureUnitCode[which(dat$CharacteristicName == variable & dat$ResultMeasure.MeasureUnitCode == unit)] <- out_unit

return(dat)
  
}


detectconvert<-function(dat, variable, unit, out_unit, conv_factor) {
  dat$DetectionQuantitationLimitMeasure.MeasureValue[which(dat$CharacteristicName == variable & dat$DetectionQuantitationLimitMeasure.MeasureUnitCode == unit)] <- dat$DetectionQuantitationLimitMeasure.MeasureValue[which(dat$CharacteristicName == variable & dat$DetectionQuantitationLimitMeasure.MeasureUnitCode == unit)] * conv_factor
  
dat$DetectionQuantitationLimitMeasure.MeasureUnitCode[which(dat$CharacteristicName == variable & dat$DetectionQuantitationLimitMeasure.MeasureUnitCode == unit)] <- out_unit

return(dat)
  
}


`%notin%` <- Negate(`%in%`)

IDdatPull<-read.csv("ID_alldata_1975_to_2020.csv")
IDdatPull$State<-c("ID")
IDdatPull$Id_num<-c(seq(1:nrow(IDdatPull)))
IDdatPull <- IDdatPull %>% 
  unite('Obs_Id', c(State, Id_num), sep = "-", remove = FALSE)
names(IDdatPull)
summary(IDdatPull)

DEdatPull<-read.csv("DE_alldata_1975_to_2020.csv")
DEdatPull$State<-c("DE")
DEdatPull$Id_num<-c(seq(1:nrow(DEdatPull)))
DEdatPull <- DEdatPull %>% 
  unite('Obs_Id', c(State, Id_num), sep = "-", remove = FALSE)
names(DEdatPull)
summary(DEdatPull)

MDdatPull<-read.csv("MD_alldata_1975_to_2020.csv")
MDdatPull$State<-c("MD")
MDdatPull$Id_num<-c(seq(1:nrow(MDdatPull)))
MDdatPull <- MDdatPull %>% 
  unite('Obs_Id', c(State, Id_num), sep = "-", remove = FALSE)
names(MDdatPull)
summary(MDdatPull)

VAdatPull<-read.csv("VA_alldata_1975_to_2020.csv")
VAdatPull$State<-c("VA")
VAdatPull$Id_num<-c(seq(1:nrow(VAdatPull)))
VAdatPull <- VAdatPull %>% 
  unite('Obs_Id', c(State, Id_num), sep = "-", remove = FALSE)
names(VAdatPull)
summary(VAdatPull)

allstates<-rbind(IDdatPull,DEdatPull,DEdatPull,MDdatPull)


#removing data that have Y's instead of keeping data that have N's

read.csv("list of unique parameters to remove.csv") -> remove_params #update this


data<- allstates[allstates$CharacteristicName %notin% remove_params$Unique.parameters,]
data<-data %>% mutate(obs_id = seq(1, nrow(data), 1))


# tdata1<-data %>% filter(!is.na(ResultDepthHeightMeasure.MeasureValue)) #identified specified depth samples
# 
# 
# tdata2<-data %>% filter(is.na(ResultDepthHeightMeasure.MeasureValue)) %>% filter(!is.na(ActivityTopDepthHeightMeasure.MeasureValue)) #these are potential integrated samples
# 
# unique(tdata2$SampleCollectionMethod.MethodName)
# method_name<-c("")
# 
# unique(tdata2$SampleCollectionMethod.MethodIdentifier)
# method_identifier<-c("")
# 
# unique(tdata2$SampleCollectionMethod.MethodIdentifierContext)
# method_context<-c("")
# 
# unique(tdata2$SampleCollectionEquipmentName)
# method_equipment<-c("")
# 
# tdata2<-tdata2 %>% filter(SampleCollectionMethod.MethodName %in% method_name | 
#                             SampleCollectionMethod.MethodIdentifier %in% method_identifier|
#                             SampleCollectionMethod.MethodIdentifierContext %in% method_context|
#                             SampleCollectionEquipmentName %in% method_equipment)  #all grab samples
# 
# tdata3<-data %>% filter(is.na(ResultDepthHeightMeasure.MeasureValue)) #identifying grab samples
# 
# unique(tdata3$SampleCollectionMethod.MethodName)
# method_name<-c("Grab sample  (dip)", "SRBC Standard Grab Sample Method", "Water Grab Sampling")
# 
# unique(tdata3$SampleCollectionMethod.MethodIdentifier)
# method_identifier<-c("GRAB-001") #all others were unknown - MBL-001, SP-001
# 
# unique(tdata3$SampleCollectionMethod.MethodIdentifierContext)
# method_context<-c("Grab sample","USGS parameter code 82398")
# 
# unique(tdata3$SampleCollectionEquipmentName)
# method_equipment<-c("Water Bottle", "Open-Mouth Bottle", "Van Dorn Bottle")
# 
# tdata3<-tdata3 %>% filter(SampleCollectionMethod.MethodName %in% method_name | 
#                             SampleCollectionMethod.MethodIdentifier %in% method_identifier|
#                             SampleCollectionMethod.MethodIdentifierContext %in% method_context|
#                             SampleCollectionEquipmentName %in% method_equipment)  #all grab samples
# 
# data2<-rbind(tdata1, tdata2, tdata3)
# rm(tdata1)
# rm(tdata2)
# rm(tdata3)
# 
# tdata4<-data %>% filter(obs_id %notin% data2$obs_id)#created object to look at all data not in datata2
# 
# unique(tdata4$CharacteristicName)
# secchiparams<-c("Depth, Secchi disk depth") #pulled out secchi data cuz it may not have depth data
# 
# tdata4<-tdata4 %>% filter(CharacteristicName %in% secchiparams) #filtered out only the secchi vars
# data<-rbind(data2, tdata4) #combined everything back together

#will need to check for each state (the depth data)

#rm(tdata4)
#rm(data2)
#data<-data %>% select(-obs_id)
#rm(MDdatPull)
#unique(data$CharacteristicName)

str(data$ResultMeasureValue)
sum(is.na(data$ResultMeasureValue))
data1<-data %>% filter(!is.na(ResultMeasureValue))
data2<-data %>% filter(!is.na(DetectionQuantitationLimitMeasure.MeasureValue)) %>% filter(is.na(ResultMeasureValue))
data3<-rbind(data1, data2)
data<-data3

rm(data1, data2, data3)


#unique organizations
unique(data$OrganizationIdentifier) #19 organizations data
table(data$OrganizationFormalName) #tells us number of obvs in each organization




#looking at activity type codes #getting rid of quality control vars
unique(data$ActivityTypeCode)
activitytype_keep<-c("Quality Control Sample-Field Blank", "Quality Control Sample-Field Replicate", "Quality Control Field Replicate Msr/Obs")
data<-data[which(data$ActivityTypeCode %notin% activitytype_keep),]
unique(data$ActivityTypeCode)

#manually checking these columns to see if these is data we keep or can drop

unique(data$SubjectTaxonomicName) #expected it to be na - to make sure nothing we need is in there
unique(data$SampleTissueAnatomyName) #also NA's - expected
unique(data$ActivityMediaSubdivisionName)
#only keeping subdivision name with surface water and NA's - dropping everything else 
data<-data %>% filter(ActivityMediaSubdivisionName == "Surface Water" | is.na(ActivityMediaSubdivisionName))
unique(data$ActivityMediaSubdivisionName)

unique(data$ResultStatusIdentifier)
unique(data$ResultValueTypeName)


unique(data$ResultDetectionConditionText)
#filtered out vars we don't need in resultsdetection condition text - did it in multistep because R doesn't handle multiple OR statements well


data<-data %>% filter(ResultDetectionConditionText != "Systematic Contamination" | is.na(ResultDetectionConditionText))

data<-data %>% filter(is.na(ResultDetectionConditionText) | ResultDetectionConditionText != "Not Reported")
unique(data$ResultDetectionConditionText)



unique(data$ResultSampleFractionText)

data<-data %>% filter(is.na(ResultSampleFractionText) | ResultSampleFractionText != "Bed Sediment")
unique(data$ResultSampleFractionText)


data<-data %>% select(-ActivityMediaName, -ActivityMediaSubdivisionName, -ActivityStartTime.Time, -ActivityStartTime.TimeZoneCode, -ActivityEndTime.Time, -ActivityEndTime.TimeZoneCode, -SampleAquifer, -HydrologicCondition, -HydrologicEvent, -SubjectTaxonomicName, -SampleTissueAnatomyName, -LaboratoryName, -AnalysisStartDate, -PreparationStartDate)

unique(data$ActivityDepthHeightMeasure.MeasureUnitCode) #has ft, feet, and m - need to convert the ones with ft and feet 
unique(data$ActivityTopDepthHeightMeasure.MeasureUnitCode) #all in m - no conversion needed
unique(data$ActivityBottomDepthHeightMeasure.MeasureUnitCode) #all in m - no conversion needed
unique(data$ResultDepthHeightMeasure.MeasureUnitCode) #all in m - no conversion needed


data$ActivityDepthHeightMeasure.MeasureValue<-ifelse(data$ActivityDepthHeightMeasure.MeasureUnitCode == "ft", data$ActivityDepthHeightMeasure.MeasureValue*0.3048, data$ActivityDepthHeightMeasure.MeasureValue)

data$ActivityDepthHeightMeasure.MeasureValue<-ifelse(data$ActivityDepthHeightMeasure.MeasureUnitCode == "feet", data$ActivityDepthHeightMeasure.MeasureValue*0.3048, data$ActivityDepthHeightMeasure.MeasureValue)


data$ActivityDepthHeightMeasure.MeasureUnitCode<-"m"


data$ResultDepthHeightMeasure.MeasureValue<-ifelse(data$ResultDepthHeightMeasure.MeasureUnitCode == "ft", data$ResultDepthHeightMeasure.MeasureValue*0.3048, data$ResultDepthHeightMeasure.MeasureValue)


data$ResultDepthHeightMeasure.MeasureUnitCode<-"m"



#check
unique(data$ActivityDepthHeightMeasure.MeasureUnitCode)
unique(data$ResultDepthHeightMeasure.MeasureUnitCode)

```

```{r}
#list of unique parameters
#unique(data$CharacteristicName)
#write.table(unique(data$CharacteristicName), "unique_parameters_ID.csv", row.names = FALSE)

```


```{r}

###creating new columns to preserve original pulled data

data$source_parameter<- data$CharacteristicName
data$source_value<- data$ResultMeasureValue
data$source_unit <- data$ResultMeasure.MeasureUnitCode
data$detectionlimit_legacy<- data$DetectionQuantitationLimitMeasure.MeasureValue
data$detectionlimit_unit_legacy<- data$DetectionQuantitationLimitMeasure.MeasureUnitCode

```


```{r}
#no3 params
vars2process <- unique(data$CharacteristicName)#only once for first occurrence

NO3_params<-c("Inorganic nitrogen (nitrate and nitrite)", "Inorganic nitrogen (nitrate and nitrite) as N", "Nitrate", "Nitrate as N","Nitrate + Nitrite") 
vars2process<-vars2process[! vars2process %in% NO3_params] #remove grab samples from list
vars2process #check if there are any missed variable

data_NO3<-data[data$CharacteristicName%in%NO3_params,] #want to match all records to the vector we created above 
unique(data_NO3$ResultSampleFractionText)

###create dataset to check for non numeric objects in dataset
temp<-data_NO3 %>% filter(is.na(as.numeric(ResultMeasureValue)))  #checks for non numeric values in result measure value - if NA's not losing any other data - can change #391 NA's - can change
data_NO3<-data_NO3 %>% mutate(ResultMeasureValue = as.numeric(ResultMeasureValue)) # non numeric values become NA


methods_table<-data_NO3 %>% 
  select(CharacteristicName,ResultMeasure.MeasureUnitCode,
         ResultAnalyticalMethod.MethodIdentifierContext, ResultAnalyticalMethod.MethodIdentifier,
         ResultAnalyticalMethod.MethodName,DetectionQuantitationLimitMeasure.MeasureUnitCode, USGSPCode) %>% 
  distinct()

write.csv(methods_table, file = "NO3_Methods.csv", row.names=FALSE, na="")
conversions<-read.csv(file = "NO3_Methods_Conversion.csv")
conversions[conversions == ""] <- NA 

check_methods<-merge(conversions,methods_table, by=c("CharacteristicName","ResultMeasure.MeasureUnitCode",
         "ResultAnalyticalMethod.MethodIdentifierContext", "ResultAnalyticalMethod.MethodIdentifier",
         "ResultAnalyticalMethod.MethodName","DetectionQuantitationLimitMeasure.MeasureUnitCode", "USGSPCode"),all = T)

write.csv(check_methods, file = "NO3_Methods_Conversion.csv", row.names=FALSE, na="")

conversions<-read.csv(file = "NO3_Methods_Conversion.csv")

conversion_temp<-conversions[is.na(conversions$Conversion),]

data_NO3_test<-merge(data_NO3,conversions,by=c("CharacteristicName","ResultMeasure.MeasureUnitCode",
         "ResultAnalyticalMethod.MethodIdentifierContext", "ResultAnalyticalMethod.MethodIdentifier",
         "ResultAnalyticalMethod.MethodName","DetectionQuantitationLimitMeasure.MeasureUnitCode", "USGSPCode"),all = T)


data_NO3_test$Converted<-c(data_NO3_test$ResultMeasureValue*data_NO3_test$Conversion)

NO3_temp<-data_NO3_test[is.na(data_NO3_test$Converted),]

#################################################################

unique(data_NO3$ResultMeasure.MeasureUnitCode)

unique(data_NO3$DetectionQuantitationLimitMeasure.MeasureUnitCode)


#working with "Inorganic nitrogen (nitrate and nitrite)"

temp<-data_NO3 %>% filter(CharacteristicName == "Inorganic nitrogen (nitrate and nitrite)")
unique(temp$ResultMeasure.MeasureUnitCode) 
unique(temp$DetectionQuantitationLimitMeasure.MeasureUnitCode)  

  
data_NO3<-resultconvert(dat = data_NO3, variable = "Inorganic nitrogen (nitrate and nitrite)", unit = "mg/l as N", out_unit = "ug/l", conv_factor = 1000)
data_NO3<-detectconvert(dat = data_NO3, variable = "Inorganic nitrogen (nitrate and nitrite)", unit = "mg/l as N", out_unit = "ug/l", conv_factor = 1000)


temp2<-temp %>% filter(CharacteristicName == "Inorganic nitrogen (nitrate and nitrite)") %>% filter(ResultMeasure.MeasureUnitCode == "mg/l")
unique(temp2$ResultAnalyticalMethod.MethodName)
unique(temp2$ResultAnalyticalMethod.MethodIdentifier)
#shows method 353.2 - reported at N - can do direct mg/l to ug/l conversion

data_NO3<-resultconvert(dat = data_NO3, variable = "Inorganic nitrogen (nitrate and nitrite)", unit = "mg/l", out_unit = "ug/l", conv_factor = 1000)
data_NO3<-detectconvert(dat = data_NO3, variable = "Inorganic nitrogen (nitrate and nitrite)", unit = "mg/l", out_unit = "ug/l", conv_factor = 1000)


#working with Inorganic nitrogen (nitrate and nitrite) as N

temp<-data_NO3 %>% filter(CharacteristicName == "Inorganic nitrogen (nitrate and nitrite) as N")
unique(temp$ResultMeasure.MeasureUnitCode) 
unique(temp$DetectionQuantitationLimitMeasure.MeasureUnitCode)  

temp2<-temp %>% filter(CharacteristicName == "Inorganic nitrogen (nitrate and nitrite) as N") %>% filter(ResultMeasure.MeasureUnitCode == "mg/l")
unique(temp2$ResultAnalyticalMethod.MethodName)
unique(temp2$ResultAnalyticalMethod.MethodIdentifier)
#4500-NO3 - suggests its a UV light technique for meeasuing NO3 as Nitrogen - can do direct conversion 

data_NO3<-resultconvert(dat = data_NO3, variable = "Inorganic nitrogen (nitrate and nitrite) as N", unit = "mg/l", out_unit = "ug/l", conv_factor = 1000)




data_NO3$CharacteristicName<-"Nitrogen, nitrite (NO2) + nitrate (NO3)"


#completed



```




```{r}

#nitrite



NO2_params<-c("Nitrite", "Nitrite as N") #only values 
data_NO2<-data[data$CharacteristicName%in%NO2_params,] #want to match all records to the vector we created above 
unique(data_NO2$ResultSampleFractionText)


###create dataset to check for non numeric objects in dataset
temp<-data_NO2 %>% filter(is.na(as.numeric(ResultMeasureValue)))  #checks for non numeric values in result measure value - if NA's not losing any other data - can change #391 NA's - can change
data_NO2<-data_NO2 %>% mutate(ResultMeasureValue = as.numeric(ResultMeasureValue)) # non numeric values become NA

unique(data_NO2$ResultMeasure.MeasureUnitCode)
unique(data_NO2$DetectionQuantitationLimitMeasure.MeasureUnitCode)


#working with "Nitrite"

temp<-data_NO2 %>% filter(CharacteristicName == "Nitrite")
unique(temp$ResultMeasure.MeasureUnitCode) 
unique(temp$DetectionQuantitationLimitMeasure.MeasureUnitCode)  

temp2<-temp %>% filter(CharacteristicName == "Nitrite") %>% filter(ResultMeasure.MeasureUnitCode == "mg/l")
unique(temp2$ResultAnalyticalMethod.MethodName)
unique(temp2$ResultAnalyticalMethod.MethodIdentifier)
#353.2 - repported as N - direct mg/l to ug/l conversion


data_NO2<-resultconvert(dat = data_NO2, variable = "Nitrite", unit = "mg/l as N", out_unit = "ug/l", conv_factor = 1000)
data_NO2<-detectconvert(dat = data_NO2, variable = "Nitrite", unit = "mg/l as N", out_unit = "ug/l", conv_factor = 1000)

data_NO2<-resultconvert(dat = data_NO2, variable = "Nitrite", unit = "mg/l", out_unit = "ug/l", conv_factor = 1000)
data_NO2<-detectconvert(dat = data_NO2, variable = "Nitrite", unit = "mg/l", out_unit = "ug/l", conv_factor = 1000)


data_NO2<-resultconvert(dat = data_NO2, variable = "Nitrite", unit = "mg/l asNO2", out_unit = "ug/l", conv_factor = 0.3044*1000)
data_NO2<-detectconvert(dat = data_NO2, variable = "Nitrite", unit = "mg/l asNO2", out_unit = "ug/l", conv_factor = 0.3044*1000)


#working with "Nitrite as N"

temp<-data_NO2 %>% filter(CharacteristicName == "Nitrite as N")
unique(temp$ResultMeasure.MeasureUnitCode) 
unique(temp$DetectionQuantitationLimitMeasure.MeasureUnitCode)  

temp2<-temp %>% filter(CharacteristicName == "Nitrite as N") %>% filter(ResultMeasure.MeasureUnitCode == "mg/l")
unique(temp2$ResultAnalyticalMethod.MethodName)
unique(temp2$ResultAnalyticalMethod.MethodIdentifier)
#4500-no2 - uv method of measure of No2 nitrogen - reported as Nitrogen - can do mg/l to ug/l direct conversion 

data_NO2<-resultconvert(dat = data_NO2, variable = "Nitrite as N", unit = "mg/l", out_unit = "ug/l", conv_factor = 1000)



data_NO2$CharacteristicName<-"Nitrogen, nitrite (NO2)"

#completed



```



```{r}

alldata_ID<- rbind(data_depth, data_secchi, data_calcium, data_aluminum_total, data_aluminum_dissolved, data_mercury_total, data_mercury_dissolved, data_methylmercury_dissolved, data_magnesium, data_selenium_total, data_selenium_dissolved, data_arsenic_total, data_arsenic_dissovled, data_atrazine_dissolved, data_ecoli, data_silica, data_chloride, data_oxygen, data_chla, data_pH, data_temp, data_sulfate, data_turb, data_cond, data_tc, data_tdc, data_alk, data_tss, data_salinity, data_truecolor, data_apparentcolor, data_DIP, data_TP, data_TDP, data_TKN, data_TDKN, data_TN, data_TDN, data_ammonia, data_NO3, data_NO2) 

write.csv(alldata_ID, file = "alldata_ID.csv", row.names = FALSE)

```


