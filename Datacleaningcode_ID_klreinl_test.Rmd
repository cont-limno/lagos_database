---
title: "Datacleaningcode_ID"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(tidyverse)
#here are functions
#for temperature

resultconvert_celsius<-function(dat, variable, unit, out_unit) {
  dat$ResultMeasureValue[which(dat$CharacteristicName == variable & dat$ResultMeasure.MeasureUnitCode == unit)] <- (dat$ResultMeasureValue[which(dat$CharacteristicName == variable & dat$ResultMeasure.MeasureUnitCode == unit)] -32)* 5/9
  
dat$ResultMeasure.MeasureUnitCode[which(dat$CharacteristicName == variable & dat$ResultMeasure.MeasureUnitCode == unit)] <- out_unit

return(dat)
  
}


detectconvert_celsius<-function(dat, variable, unit, out_unit) {
  dat$DetectionQuantitationLimitMeasure.MeasureValue[which(dat$CharacteristicName == variable & dat$DetectionQuantitationLimitMeasure.MeasureUnitCode == unit)] <- (dat$DetectionQuantitationLimitMeasure.MeasureValue[which(dat$CharacteristicName == variable & dat$DetectionQuantitationLimitMeasure.MeasureUnitCode == unit)] * -32)*5/9
  
dat$DetectionQuantitationLimitMeasure.MeasureUnitCode[which(dat$CharacteristicName == variable & dat$DetectionQuantitationLimitMeasure.MeasureUnitCode == unit)] <- out_unit

return(dat)
  
}

#for all other conversions

resultconvert<-function(dat, variable, unit, out_unit, conv_factor) {
  dat$ResultMeasureValue[which(dat$CharacteristicName == variable & dat$ResultMeasure.MeasureUnitCode == unit)] <- dat$ResultMeasureValue[which(dat$CharacteristicName == variable & dat$ResultMeasure.MeasureUnitCode == unit)] * conv_factor
  
dat$ResultMeasure.MeasureUnitCode[which(dat$CharacteristicName == variable & dat$ResultMeasure.MeasureUnitCode == unit)] <- out_unit

return(dat)
  
}


detectconvert<-function(dat, variable, unit, out_unit, conv_factor) {
  dat$DetectionQuantitationLimitMeasure.MeasureValue[which(dat$CharacteristicName == variable & dat$DetectionQuantitationLimitMeasure.MeasureUnitCode == unit)] <- dat$DetectionQuantitationLimitMeasure.MeasureValue[which(dat$CharacteristicName == variable & dat$DetectionQuantitationLimitMeasure.MeasureUnitCode == unit)] * conv_factor
  
dat$DetectionQuantitationLimitMeasure.MeasureUnitCode[which(dat$CharacteristicName == variable & dat$DetectionQuantitationLimitMeasure.MeasureUnitCode == unit)] <- out_unit

return(dat)
  
}


`%notin%` <- Negate(`%in%`)

IDdatPull<-read.csv("ID_alldata_1975_to_2020.csv")
IDdatPull <- read.csv("~/Trout Lake Station Dropbox/Noah Lottig/CL_LAGOSUS_exports/LAGOSUS_LIMNO/US_NEW/raw_data/ID_alldata_1975_to_2020.csv")

IDdatPull$State<-c("ID")
IDdatPull$Id_num<-c(seq(1:nrow(IDdatPull)))
IDdatPull <- IDdatPull %>% 
  unite('Obs_Id', c(State, Id_num), sep = "-", remove = FALSE)
names(IDdatPull)
summary(IDdatPull)

DEdatPull<-read.csv("DE_alldata_1975_to_2020.csv")
DEdatPull<-read.csv("~/Trout Lake Station Dropbox/Noah Lottig/CL_LAGOSUS_exports/LAGOSUS_LIMNO/US_NEW/raw_data/DE_alldata_1975_to_2020.csv")

DEdatPull$State<-c("DE")
DEdatPull$Id_num<-c(seq(1:nrow(DEdatPull)))
DEdatPull <- DEdatPull %>% 
  unite('Obs_Id', c(State, Id_num), sep = "-", remove = FALSE)
names(DEdatPull)
summary(DEdatPull)

MDdatPull<-read.csv("MD_alldata_1975_to_2020.csv")
MDdatPull<-read.csv("~/Trout Lake Station Dropbox/Noah Lottig/CL_LAGOSUS_exports/LAGOSUS_LIMNO/US_NEW/raw_data/MD_alldata_1975_to_2020.csv")


MDdatPull$State<-c("MD")
MDdatPull$Id_num<-c(seq(1:nrow(MDdatPull)))
MDdatPull <- MDdatPull %>% 
  unite('Obs_Id', c(State, Id_num), sep = "-", remove = FALSE)
names(MDdatPull)
summary(MDdatPull)

VAdatPull<-read.csv("VA_alldata_1975_to_2020.csv")
VAdatPull<-read.csv("~/Trout Lake Station Dropbox/Noah Lottig/CL_LAGOSUS_exports/LAGOSUS_LIMNO/US_NEW/raw_data/VA_alldata_1975_to_2020.csv")


VAdatPull$State<-c("VA")
VAdatPull$Id_num<-c(seq(1:nrow(VAdatPull)))
VAdatPull <- VAdatPull %>% 
  unite('Obs_Id', c(State, Id_num), sep = "-", remove = FALSE)
names(VAdatPull)
summary(VAdatPull)

allstates<-rbind(IDdatPull,DEdatPull,DEdatPull,MDdatPull)
#figure out how to autodelete files that contain datpull
rm(DEdatPull,IDdatPull,VAdatPull,MDdatPull)

#removing data that have Y's instead of keeping data that have N's
read.csv("list of unique parameters to remove.csv") -> remove_params #update this
data<- allstates[allstates$CharacteristicName %notin% remove_params$Unique.parameters,]
data <- data %>% 
  unite('Method_Id', c(ResultAnalyticalMethod.MethodIdentifierContext, ResultAnalyticalMethod.MethodIdentifier), sep = " ", remove = FALSE)

#get only locations that have a lagoslakeid
lagos_link <- read_csv("lagos_wqp_20210920.csv") %>% 
    rename(MonitoringLocationIdentifier = wqp_monitoringlocationidentifier)
data <- data %>% left_join(lagos_link) %>% drop_na(lagoslakeid)


str(data$ResultMeasureValue)
sum(is.na(data$ResultMeasureValue))
data1<-data %>% filter(!is.na(ResultMeasureValue))
data2<-data %>% filter(!is.na(DetectionQuantitationLimitMeasure.MeasureValue)) %>% filter(is.na(ResultMeasureValue))
data3<-rbind(data1, data2)
data<-data3
rm(data1, data2, data3)

#unique organizations
unique(data$OrganizationIdentifier) #19 organizations data
table(data$OrganizationFormalName) #tells us number of obvs in each organization

#looking at activity type codes #getting rid of quality control vars

remove_activity <- unique(data$ActivityTypeCode)
activitytype_keep<-c("Quality Control Sample-Field Blank", "Quality Control Sample-Field Replicate", "Quality Control Field Replicate Msr/Obs")
remove_activity <- remove_activity[!remove_activity %in% activitytype_keep]
remove_activity

data<-data[which(data$ActivityTypeCode %notin% activitytype_keep),]
unique(data$ActivityTypeCode)

#manually checking these columns to see if these is data we keep or can drop

unique(data$SubjectTaxonomicName) #expected it to be na - to make sure nothing we need is in there
unique(data$SampleTissueAnatomyName) #also NA's - expected
unique(data$ActivityMediaSubdivisionName)
#only keeping subdivision name with surface water and NA's - dropping everything else 
data<-data %>% filter(ActivityMediaSubdivisionName == "Surface Water" | is.na(ActivityMediaSubdivisionName))
unique(data$ActivityMediaSubdivisionName)

unique(data$ResultStatusIdentifier)
data <- data %>% filter(ResultStatusIdentifier != "Rejected")

unique(data$ResultValueTypeName)
data<-data %>% filter(ResultValueTypeName == "Actual" | is.na(ResultValueTypeName))
unique(data$ResultValueTypeName)

unique(data$ResultDetectionConditionText)
#filtered out vars we don't need in resultsdetection condition text - did it in multistep because R doesn't handle multiple OR statements well

data<-data %>% filter(ResultDetectionConditionText != "Systematic Contamination" | is.na(ResultDetectionConditionText))
data<-data %>% filter(is.na(ResultDetectionConditionText) | ResultDetectionConditionText != "Not Reported")
unique(data$ResultDetectionConditionText)



unique(data$ResultSampleFractionText)
data<-data %>% filter(is.na(ResultSampleFractionText) | ResultSampleFractionText != "Bed Sediment")
data<-data %>% filter(is.na(ResultSampleFractionText) | ResultSampleFractionText != "Recoverable")
data<-data %>% filter(is.na(ResultSampleFractionText) | ResultSampleFractionText != "Acid Soluble")
data<-data %>% filter(is.na(ResultSampleFractionText) | ResultSampleFractionText != "Total Recoverable")
unique(data$ResultSampleFractionText)

data<-data %>% select(-ActivityMediaName, -ActivityMediaSubdivisionName, -ActivityStartTime.Time, -ActivityStartTime.TimeZoneCode, -ActivityEndTime.Time, -ActivityEndTime.TimeZoneCode, -SampleAquifer, -HydrologicCondition, -HydrologicEvent, -SubjectTaxonomicName, -SampleTissueAnatomyName, -LaboratoryName, -AnalysisStartDate, -PreparationStartDate)

#has ft, feet, and m - need to convert the ones with ft and feet 
unique(data$ActivityDepthHeightMeasure.MeasureUnitCode) 
data$ActivityDepthHeightMeasure.MeasureValue<-ifelse(data$ActivityDepthHeightMeasure.MeasureUnitCode == "ft", data$ActivityDepthHeightMeasure.MeasureValue*0.3048, data$ActivityDepthHeightMeasure.MeasureValue)
data$ActivityDepthHeightMeasure.MeasureValue<-ifelse(data$ActivityDepthHeightMeasure.MeasureUnitCode == "feet", data$ActivityDepthHeightMeasure.MeasureValue*0.3048, data$ActivityDepthHeightMeasure.MeasureValue)
data$ActivityDepthHeightMeasure.MeasureUnitCode[!is.na(data$ActivityDepthHeightMeasure.MeasureUnitCode)]<-"m"

unique(data$ResultDepthHeightMeasure.MeasureUnitCode) #all in m - no conversion needed
data$ResultDepthHeightMeasure.MeasureValue<-ifelse(data$ResultDepthHeightMeasure.MeasureUnitCode == "ft", data$ResultDepthHeightMeasure.MeasureValue*0.3048, data$ResultDepthHeightMeasure.MeasureValue)
data$ResultDepthHeightMeasure.MeasureValue<-ifelse(data$ResultDepthHeightMeasure.MeasureUnitCode == "feet", data$ResultDepthHeightMeasure.MeasureValue*0.3048, data$ResultDepthHeightMeasure.MeasureValue)
data$ResultDepthHeightMeasure.MeasureUnitCode[!is.na(data$ResultDepthHeightMeasure.MeasureUnitCode)]<-"m"

unique(data$ActivityTopDepthHeightMeasure.MeasureUnitCode) #all in m - no conversion needed
#add


unique(data$ActivityBottomDepthHeightMeasure.MeasureUnitCode) #all in m - no conversion needed
#add



#check
unique(data$ActivityDepthHeightMeasure.MeasureUnitCode)
unique(data$ResultDepthHeightMeasure.MeasureUnitCode)

```
```{r}

###creating new columns to preserve original pulled data

data$source_parameter<- data$CharacteristicName
data$source_value<- data$ResultMeasureValue
data$source_unit <- data$ResultMeasure.MeasureUnitCode
data$detectionlimit_legacy<- data$DetectionQuantitationLimitMeasure.MeasureValue
data$detectionlimit_unit_legacy<- data$DetectionQuantitationLimitMeasure.MeasureUnitCode

```
```{r}
#Depth
vars2process <- unique(data$CharacteristicName) #only once for first occurrence

Depth_params<-c("Depth, data-logger (non-ported)", "Depth", "Depth, data-logger (ported)", "Depth, bottom") #only values for depth
vars2process <- vars2process[!vars2process %in% Depth_params]
vars2process

data_depth<-data[data$CharacteristicName%in%Depth_params,] #want to match all records to the vector we created above 

###create dataset to check for non numeric objects in dataset
temp<-data_depth %>% filter(is.na(as.numeric(ResultMeasureValue)))  #checks for non numeric values in result measure value - if NA's not losing any other data - can change
data_depth<-data_depth %>% mutate(ResultMeasureValue = as.numeric(ResultMeasureValue)) # non numeric values become NA

methods_table<-data_depth %>% 
  select(CharacteristicName,
         ResultMeasure.MeasureUnitCode,
         Method_Id,
         ResultAnalyticalMethod.MethodName,
         DetectionQuantitationLimitMeasure.MeasureUnitCode,
         USGSPCode) %>% 
  distinct()

if(file.exists("conversion_files/depth_Methods_Conversion.csv")==FALSE) {
  write_csv(methods_table,"conversion_files/depth_Methods.csv")
  print("Conversion File needs to be created")
}

conversions <- read.csv(file = "conversion_files/depth_Methods_Conversion.csv") # read in list of conversion factors
conversions[conversions == ""] <- NA #assign NA to blank values
check_methods<-merge(conversions,methods_table, by=c("CharacteristicName",
                                                     "ResultMeasure.MeasureUnitCode",
                                                     "Method_Id",
                                                     "ResultAnalyticalMethod.MethodName",
                                                     "DetectionQuantitationLimitMeasure.MeasureUnitCode", 
                                                     "USGSPCode"),all = T) #merge methods with conversion table to identify methods without a conversion factor
#write file if conversion factors need to be added
if(nrow(conversions)!=nrow(check_methods)) {
  write.csv(check_methods, file = "conversion_files/depth_Methods_Conversion.csv", row.names=FALSE, na="")
}

if(is.na(min(check_methods$Conversion))) {print("FIX Conversions and reload files")}

data_depth<-merge(data_depth,conversions,by=c("CharacteristicName",
                                              "ResultMeasure.MeasureUnitCode",
                                              "Method_Id","ResultAnalyticalMethod.MethodName",
                                              "DetectionQuantitationLimitMeasure.MeasureUnitCode", 
                                              "USGSPCode"),all = T) #Assign conversion factors using unique characteristic and method identifiers 

data_depth <- data_depth %>% 
  mutate(Converted = ResultMeasureValue*Conversion) %>% 
  mutate(Converted_dl = DetectionQuantitationLimitMeasure.MeasureValue*Conversion_dl)

data_depth_temp <- data_depth %>% 
  filter(!is.na(ResultMeasureValue)) %>% 
  filter(is.na(Converted))

data_depth_temp <- data_depth %>% 
  filter(!is.na(DetectionQuantitationLimitMeasure.MeasureValue)) %>% 
  filter(is.na(Converted_dl))

rm(data_depth_temp)
rm(conversions)
rm(check_methods)
rm(methods_table)
rm(temp)

data_depth$ResultMeasure.MeasureUnitCode[!is.na(data_depth$ResultMeasure.MeasureUnitCode)] <- "m"
data_depth$DetectionQuantitationLimitMeasure.MeasureUnitCode[!is.na(data_depth$DetectionQuantitationLimitMeasure.MeasureUnitCode)] <- "m"

unique(data_depth$ResultMeasure.MeasureUnitCode) #checked units #change ft to m
unique(data_depth$DetectionQuantitationLimitMeasure.MeasureUnitCode) #checked units #all NA's no change needed

data_depth$CharacteristicName<-"Depth"  #set all depth params as depth

#done
```




```{r}
#no3 params
NO3_params<-c("Inorganic nitrogen (nitrate and nitrite)", "Inorganic nitrogen (nitrate and nitrite) as N", "Nitrate", "Nitrate as N","Nitrate + Nitrite") 
vars2process<-vars2process[! vars2process %in% NO3_params] #remove grab samples from list
vars2process #check if there are any missed variable

data_NO3<-data[data$CharacteristicName%in%NO3_params,] #want to match all records to the vector we created above 
unique(data_NO3$ResultSampleFractionText)

###create dataset to check for non numeric objects in dataset
temp<-data_NO3 %>% filter(is.na(as.numeric(ResultMeasureValue)))  #checks for non numeric values in result measure value - if NA's not losing any other data - can change #391 NA's - can change
data_NO3<-data_NO3 %>% mutate(ResultMeasureValue = as.numeric(ResultMeasureValue)) # non numeric values become NA


methods_table<-data_NO3 %>% 
  select(CharacteristicName,ResultMeasure.MeasureUnitCode,
         Method_Id,
         ResultAnalyticalMethod.MethodName,DetectionQuantitationLimitMeasure.MeasureUnitCode, USGSPCode) %>% 
  distinct()

#write.csv(methods_table, file = "conversion_files/NO3_Methods.csv", row.names=FALSE, na="")
conversions<-read.csv(file = "conversion_files/NO3_Methods_Conversion.csv") # read in list of conversion factors
conversions[conversions == ""] <- NA #assign NA to blank values

check_methods<-merge(conversions,methods_table, by=c("CharacteristicName","ResultMeasure.MeasureUnitCode",
         "Method_Id",
         "ResultAnalyticalMethod.MethodName","DetectionQuantitationLimitMeasure.MeasureUnitCode", "USGSPCode"),all = T) #merge methods with conversion table to identify methods without a conversion factor

write.csv(check_methods, file = "conversion_files/NO3_Methods_Conversion.csv", row.names=FALSE, na="") #write new conversion file with new methods and assign values for conversion factors

conversions<-read.csv(file = "conversion_files/NO3_Methods_Conversion.csv") #read in new conversion file

conversion_temp<-conversions[is.na(conversions$Conversion),] #double check for missing conversion factors

conversion_temp_notes<-conversions[!is.na(conversions$Notes),] #check for flags on methods

data_NO3_test<-merge(data_NO3,conversions,by=c("CharacteristicName","ResultMeasure.MeasureUnitCode",
         "Method_Id",
         "ResultAnalyticalMethod.MethodName","DetectionQuantitationLimitMeasure.MeasureUnitCode", "USGSPCode"),all = T) #Assign conversion factors using unique characteristic and method identifiers 

data_NO3_test$Converted<-c(data_NO3_test$ResultMeasureValue*data_NO3_test$Conversion) #convert measurement data

data_NO3_test$Converted_dl<-c(data_NO3_test$ResultMeasureValue*data_NO3_test$Conversion_dl) #convert detection data

NO3_temp<-data_NO3_test[is.na(data_NO3_test$Converted),] #check for missing converted data as a final check

#################################################################


data_NO3_test$CharacteristicName<-"Nitrogen, nitrite (NO2) + nitrate (NO3)"


#completed

#clean up
rm(temp)
rm(methods_table)
rm(check_methods)
rm(conversions)
rm(conversion_temp)
rm(NO3_temp)


```




```{r}

alldata_ID<- rbind(data_depth, data_secchi, data_calcium, data_aluminum_total, data_aluminum_dissolved, data_mercury_total, data_mercury_dissolved, data_methylmercury_dissolved, data_magnesium, data_selenium_total, data_selenium_dissolved, data_arsenic_total, data_arsenic_dissovled, data_atrazine_dissolved, data_ecoli, data_silica, data_chloride, data_oxygen, data_chla, data_pH, data_temp, data_sulfate, data_turb, data_cond, data_tc, data_tdc, data_alk, data_tss, data_salinity, data_truecolor, data_apparentcolor, data_DIP, data_TP, data_TDP, data_TKN, data_TDKN, data_TN, data_TDN, data_ammonia, data_NO3, data_NO2) 

write.csv(alldata_ID, file = "alldata_ID.csv", row.names = FALSE)

```


